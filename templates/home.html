<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    </head>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <title>Road Trip Planner</title>
</head>
<body>
    
    
    <div id="app">
        <div class="container mt-3">
            <h1>Road Trip Planner</h1>
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Search cities in England" aria-label="Recipientâ€™s username"
                    aria-describedby="button-addon2" v-model="query">
                <button class="btn btn-outline-secondary" type="button" @click="setMarker">Go</button>
            </div>
            <div id="map"></div>
            <div v-if="length" class="alert alert-dark mt-2" role="alert">
                {length} Kms
            </div>
            <!-- <p v-if="length">{length} Kms</p> -->
            <div v-if="loading">
                <p>loading...{loading}</p>
            </div>
            <div v-else class="mt-3">
                <h3>List of Cities to visit</h3>
                <ul class="list-group">
                    <li v-for="city in cities" :key="city.id" class="list-group-item d-flex justify-content-between align-items-center">
                        { city.name }
                        <span class="badge text-bg-primary rounded-pill" @click="removeMarker(city.id)">X</span>
                    </li>
                </ul>
      
            </div>
           
        </div>
    </div>
    
    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    message: 'Hello Vue!',
                    map: null,
                    markers: [],
                    query:'',
                    cities:[],
                    loading:false,
                     pointA:null,
                     pointB:null,
                     polyline:null,
                     length:0
                }
            },
            delimiters: ['{','}'],
            methods: {
                setMarker(){
                        if(this.query != ""){
                            const url = `https://api.api-ninjas.com/v1/geocoding?city=${this.query}&country=England`
                            fetch(url, {
                                headers: {
                                    "X-Api-Key": "la/j/xsA5RcYkjAz8XOp5A==DHEPt3qxe0kyeaSx"
                                }

                            })
                            .then(response => response.json())
                            .then(data => {
                                // console.log(data)

                                const location = {
                                    "latitude" : data[0].latitude,
                                    "longitude": data[0].longitude,
                                    "name": data[0].name,
                                }
                                
                                //add marker
                                // this.marker = L.marker([data[0].latitude, data[0].longitude])
                                //                 .addTo(this.map)
                                                // .bindPopup(data[0].name)
                                                // .openPopup();


                                // this.cities.push(location)
                                this.query = ""
                                //save to db
                                fetch("/save-location", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify(location)
                                    })
                                    .then(response => response.json())
                                    .then(result => {
                                        console.log("Saved in DB:", result)

                                        this.fetchLocations()
                        
                                    })
                                    .catch(err => console.error("Error saving location:", err))
                            })
                            .catch(error => console.error('Error:', error));
                        }else{
                            alert('Enter a city in england')
                        }
                },
                fetchLocations() {
                    this.loading = true

                    // Clear existing markers before adding new ones
                    if (this.markers && this.markers.length > 0) {
                        this.markers.forEach(markerObj => {
                            this.map.removeLayer(markerObj.marker)
                        })
                    }
                    this.markers = [] // Reset markers array

                    fetch("/get-locations")
                        .then(res => res.json())
                        .then(data => {
                            // console.log(data) 
                            let bounds = []

                            data.forEach(loc => {
                                const marker = L.marker([loc.latitude, loc.longitude])
                                    .addTo(this.map)
                                    .bindPopup(loc.name)

                                // Store marker reference
                                this.markers.push({
                                    marker: marker,
                                    location: loc,
                                    latlng: L.latLng(loc.latitude, loc.longitude)
                                })

                                // Add click handler for polyline
                                this.addMarkerClickHandler(marker)

                                bounds.push([loc.latitude, loc.longitude])
                            })
                            //setting map to view
                            if (bounds.length > 0) {
                                this.map.fitBounds(bounds)
                            }
                            this.loading = false
                            this.cities = data

                        })
                        .catch(err => console.error("Error fetching locations:", err))
                },
                removeMarker(id){
                     fetch(`/location/${id}/delete`, {
                            method: "POST",
                        })
                        .then(response => response.json())
                        .then(result => {
                            console.log("deleted from DB:", result)
                            this.cities = this.cities.filter(city => city.id !== id)
                            this.fetchLocations()
                        })
                        .catch(err => console.error("Error saving location:", err))
                },
                addMarkerClickHandler(marker) {
                    marker.on('click', (e) => {
                        const { lat, lng } = e.latlng;
                        //if pointA is null, set pointA to current latlong
                        if (!this.pointA) {
                            this.pointA = e.latlng
                        } else if (!this.pointB) {//if pointB is null, set pointB to current latlong
                            this.pointB = e.latlng
                            this.polyline = L.polyline([this.pointA, this.pointB], {
                                color: "red"
                            }).addTo(this.map)
                            this.length = (this.map.distance(this.pointA, this.pointB) / 1000).toFixed(2)
                        } else {
                            if (this.polyline) {
                                this.map.removeLayer(this.polyline)
                                this.polyline = null
                                this.pointA = e.latlng
                                this.pointB = null
                            }
                        }
                    });
                },
                    
            },
            mounted() {
               this.map = L.map('map').setView([51.505, -0.09], 13);

               L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(this.map);
                this.fetchLocations() 
            }   
        }).mount('#app')
    </script>
</body>
</html>